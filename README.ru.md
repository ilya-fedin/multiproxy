# Multiproxy
Multiproxy - набор скриптов и утилит с [3proxy](https://github.com/z3APA3A/3proxy) во главе угла для мультиаплинкового (с несколькими интернет-соединениями) проксирования.

## Установка
Есть два способа установки Multiproxy:  
* Через установку snap-пакета
* Через установку с помощью GNU Make

### Установка файрволла
Multiproxy умеет работать как через iptables, так и через firewalld. Вы можете использовать iptables, но лично я рекомендую использовать вместе с firewalld. Пример установки firewalld на нескольких основных дистрибутивах:

Arch Linux:  
```sh
sudo pacman -S firewalld
sudo systemctl enable --now firewalld
```

Debian/Ubuntu:  
```sh
sudo apt-get install firewalld
```

Fedora:  
```sh
sudo dnf install firewalld
```

CentOS (но на ней он предустановлен):  
```sh
sudo yum install firewalld
sudo systemctl enable --now firewalld
```

### Установка сетевого менеджера
Кроме того, для корректной работы Multiproxy, ему необходимо совершать действия при изменении состояния сетевых интерфейсов. Для этого в комплекте идут хуки dhcpcd. Вы можете написать хуки для своего сетевого менеджера или поставить dhcpcd. Пример установки dhcpcd на нескольких основных дистрибутивах:

Arch Linux (но на нем он предустановлен):  
```sh
sudo pacman -S dhcpcd
sudo systemctl enable --now dhcpcd
```

Debian/Ubuntu:  
```sh
sudo apt-get install dhcpcd5
```

Fedora:  
```sh
sudo dnf install dhcpcd
```

CentOS:  
```sh
sudo yum install dhcpcd
sudo systemctl enable --now dhcpcd
```

### Установка Multiproxy через snapd
Необходоимо установить [snapd](https://docs.snapcraft.io/installing-snapd/6735) для установки этим способом. Пример установки на нескольких основных дистрибутивах:

С [yay](https://github.com/Jguer/yay) на Arch Linux:  
```sh
yay -S snapd
sudo systemctl enable --now snapd.socket
```

Debian/Ubuntu:  
```sh
sudo apt-get install snapd
```

Fedora:
```sh
sudo dnf install snapd
```

CentOS пока не поддерживает snapd.

Также, необходимо создать символическую ссылку для включения поддержки snap-пакетов с classic confinement (таких, как этот):  
```sh
sudo ln -s /var/lib/snapd/snap /snap
```

Собственно, установка Multiproxy через snapd:  
```sh
sudo snap install --classic --dangerous multiproxy_*.snap
```

Snap-пакеты находятся на странице с релизами.

Если не было никаких ошибок, то установка прошла успешно.

### Установка Multiproxy через GNU Make
Необходимо установить make, [docker](https://docs.docker.com/install/) и [docker-compose](https://docs.docker.com/compose/install/) для установки этим способом. Пример установки на нескольких основных дистрибутивах:

Arch Linux:
```sh
sudo pacman -S make docker docker-compose
sudo systemctl enable --now docker
```

Debian/Ubuntu:
```sh
sudo apt-get install make docker docker-compose
```

CentOS:
```sh
sudo dnf install make docker docker-compose
sudo systemctl enable --now docker
```

Но, хочу заметить, что в случае с Debian/Ubuntu, Fedora и CentOS, лучше всего произвести установку Docker из официального репозитория Docker.

Также, нужно скопировать папку с репозиторием в /opt (папка с файлами Multiproxy должна быть /opt/multiproxy) и исполнить следующие команды:  
```sh
sudo make
sudo make install-all
```

Если не было никаких ошибок, то установка прошла успешно.

## Настройка
### dhcpcd
Прежде всего, необходимо настроить Ваш сетевой менеджер для корректной работы с Multiproxy. Ниже дан пример для dhcpcd.

Первое, что нужно сделать, это запретить всем интерфейса устанавливать default route. Откройте /etc/dhcpcd.conf и добавьте в конец:  
```
nogateway
```

Далее, включите установку default route для главного сетевого интерфейса, с которого должен идти интернет на все остальное:  
```
interface enp1s0
gateway
metric 0
```

Также, в этом блоке приведена строка `metric 0`, которая нужна для того, чтобы маршрут этого интерфейса имел приоритет над маршрутами, устанавливаемыми fallback-хуком Multiproxy для корректной работы SimpleFailover.

Как только вы закончили редактирование dhcpcd.conf, сохраните и закройте файл.

### 3proxy
Для настройки 3proxy, откройте `3proxy.cfg`, добавьте Ваши настройки и сохраните его. Учтите, что Вы не должны заменять `@USER@`, `@PASSWORD@` или `@PORT@`, но вы можете раскомментировать настройки аутентификации. Также, если Вам нужен один логин для всех экземпляров 3proxy, Вы можете заменить `@USER@` и `@PASSWORD@` вашими данными, но лучше оставить эту строку закомментированной и добавить еще одну директиву `users`.

### Multiproxy
Для настройки самого Multiproxy, откройте файл `instances`. Этот файл имеет следующий синтаксис:  
```
192.168.1.1	enp1s0	0x1	101	501	27001	user1	1111	reconnect	600
192.168.2.1	enp2s0	0x2	102	502	27002	user2	2222	reconnect	600
```

Каждая строка - экземпляр 3proxy, они имеют по 10 опций, которые разделены символом табуляции (не пробелом!).  

Описание опций:
1. IP-адрес шлюза аплинка, который будет использован с экземпляром 3proxy.  
2. Имя сетевого интерфейса аплинка, которое будет использовано с экземпляром 3proxy.  
3. Метка, которая будет добавлена к пакетам экземпляра 3proxy. Она используется для пометки трафика экзмепляра 3proxy, чтобы он шел по нужному маршруту. Эта метка не уходит дальше хоста, на котором она поставлена, поэтому провайдер не увидит ничего подозрительного. **Вы можете просто добавлять +1 для каждого экземпляра.**  
4. Таблица маршрутизации аплинка экземпляра 3proxy. Default route аплинка будет добавлен в эту таблицу, а трафик с меткой этого аплинка будет использовать эту таблицу. **Вы можете просто добавлять +1 для каждого экземпляра.**  
5. UID экземпляра 3proxy. UID используется для того, чтобы понять, от какого экземпляра 3proxy идет трафик и пометить его нужной меткой. **Вы можете просто добавлять +1 для каждого экземпляра.**  
6. Порт экземпляра 3proxy. **Вы можете просто добавлять +1 для каждого экземпляра.**  
7. Имя пользователя экземпляра 3proxy.  
8. Пароль пользователя экземпляра 3proxy.  
9. Способ переподключения аплинка экземпляра 3proxy. Если вы используете устройство Huawei HiLink, то вы можете активировать автопереподключение вашего устрйоства. Есть два способа: `reconnect` и `reboot`.  
10. Интервал переподключения аплинка экземпляра 3proxy, в секундах.

Можно указать только IP-адрес шлюза, только имя сетевого интерфейса или оба сразу.

После конфигурирования Multiproxy, необходимо применить настройки.

#### Применение настроек, если установка выполнена с помощью snapd
```sh
sudo multiproxy.apply-settings
```

Если не было никаких ошибок, то настройки применены успешно.

#### Применение настроек, если установка выполнена с помощью GNU Make
```sh
sudo /opt/multiproxy/bin/apply-settings
```

Если не было никаких ошибок, то настройки применены успешно.

### SimpleFailover
Этот скрипт проверяет интернет-соединение, выключает выход через главный сетевой интерфейс при потере соединения и возвращает при восстановлении интернета. Настройка этого скрипта необязательна.

Когда скрипт удаляет default route, начинает использоваться default route с более высокой метрикой. Default route'ы аплинков (интернет-соединений) Multiproxy используют в качестве метрики число в колонке `table` файла `instances`. Как только интернет-соединение пропадает, в качестве главного интернет-соединения будет использоваться аплинк с самым маленьким числом в колонке `table`. Этот скрипт не следит за интернет-соединением на аплинках Multiproxy, поэтому, если вам нужно проверять интернет-соединение на всех аплинках, Вы должны установить более мощный failover.

Файл конфигурации SimpleFailover при установке через snap-пакет: `/var/snap/multiproxy/current/default/simplefailover`, при установке через GNU Make: `/opt/mutilproxy/default/simplefailover`.

## Удаление
### snapd
```sh
sudo snap remove multiproxy
```

### GNU Make
```sh
cd /opt/multiproxy
sudo make uninstall-all
cd ..
sudo rm -r multiproxy
```
